name: Create Release

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g., v0.2.0)'
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Get Version
        id: get_version
        run: |
          python - <<'PY'
          import os
          import tomllib
          from pathlib import Path

          data = tomllib.loads(Path("blender_manifest.toml").read_text(encoding="utf-8"))
          version = data["version"]

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
              fh.write(f"version={version}\n")
              fh.write(f"zip_name=Rainys_Bulk_Scene_Tools.v{version}.zip\n")
          PY
      
      - name: Create ZIP
        run: |
          ADDON_DIR=addon_files/Rainys_Bulk_Scene_Tools
          mkdir -p "$ADDON_DIR"

          # Copy top-level files if they exist
          for file in __init__.py rainys_repo_bootstrap.py blender_manifest.toml readme.md changelog.md requirements.txt; do
            if [ -f "$file" ]; then
              cp "$file" "$ADDON_DIR"/
            else
              echo "Skipping missing file: $file"
            fi
          done

          # Copy packages
          cp -r panels "$ADDON_DIR"/
          cp -r ops "$ADDON_DIR"/
          cp -r utils "$ADDON_DIR"/

          # Create the zip from the temporary directory
          cd addon_files
          zip -r "../${{ steps.get_version.outputs.zip_name }}" ./*
      
      - name: Upload Release Asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.get_version.outputs.zip_name }}
          tag_name: ${{ inputs.release_tag }}
          draft: true 